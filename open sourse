using System;
using System.Diagnostics;
using System.IO;
using System.Net;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace StateW1nInjector
{
    class Program
    {
        [DllImport("kernel32.dll")]
        static extern IntPtr OpenProcess(uint dwDesiredAccess, bool bInheritHandle, int dwProcessId);

        [DllImport("kernel32.dll")]
        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

        [DllImport("kernel32.dll")]
        static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, uint nSize, out UIntPtr lpNumberOfBytesWritten);

        [DllImport("kernel32.dll")]
        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

        const uint PROCESS_ALL_ACCESS = 0x1F0FFF;
        const uint MEM_COMMIT = 0x1000;
        const uint MEM_RESERVE = 0x2000;
        const uint PAGE_READWRITE = 0x04;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        static string currentVersion = "1.3.0";
        static string githubRepo = "https://raw.githubusercontent.com/DofikShe/StateW1n-Injector/main/";
        static string versionUrl = "https://raw.githubusercontent.com/DofikShe/StateW1n-Injector/main/version.txt";
        static string exeUrl = "https://raw.githubusercontent.com/DofikShe/StateW1n-Injector/main/StateW1n.exe";
        static string luaScriptsUrl = "https://raw.githubusercontent.com/DofikShe/StateW1n-Injector/main/scripts/";
        static string tempUpdateExe = Path.GetTempPath() + "StateW1n_new.exe";
        static string tempUpdaterScript = Path.GetTempPath() + "StateW1n_update.bat";
        static string currentExePath = Process.GetCurrentProcess().MainModule.FileName;
        static string currentDir = Path.GetDirectoryName(currentExePath);

        static WebClient webClient = new WebClient();

        [STAThread]
        static void Main(string[] args)
        {
            Console.Title = $"StateW1n Injector v{currentVersion}";
            Console.ForegroundColor = ConsoleColor.Magenta;
            Console.WriteLine($"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            Console.WriteLine($"‚ïë         StateW1n Injector        ‚ïë");
            Console.WriteLine($"‚ïë           Version {currentVersion}           ‚ïë");
            Console.WriteLine($"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            Console.ResetColor();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
            if (args.Length > 0 && args[0] == "--cleanup")
            {
                CleanupOldVersion();
                return;
            }

            if (args.Length > 0 && args[0] == "--updated")
            {
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("‚úÖ Successfully updated to latest version!");
                Console.ResetColor();
            }

            try
            {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–µ
                Task.Run(() => CheckForUpdatesAsync());

                // –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
                if (args.Length > 0 && args[0] == "--silent")
                {
                    SilentMode(args);
                }
                else
                {
                    InteractiveMode();
                }
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"Error: {ex.Message}");
                Console.ResetColor();
                Console.WriteLine("Press any key to exit...");
                Console.ReadKey();
            }
        }

        static async Task CheckForUpdatesAsync()
        {
            try
            {
                await Task.Delay(2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                
                Console.ForegroundColor = ConsoleColor.Cyan;
                Console.WriteLine("üîç Checking for updates from GitHub...");
                Console.ResetColor();
                
                webClient.Headers.Add("User-Agent", "StateW1n-Updater/1.0");
                string latestVersion = await webClient.DownloadStringTaskAsync(versionUrl);
                latestVersion = latestVersion.Trim();

                if (IsNewerVersion(latestVersion, currentVersion))
                {
                    Console.ForegroundColor = ConsoleColor.Yellow;
                    Console.WriteLine($"üîÑ New version available: {latestVersion}");
                    Console.WriteLine($"üì• Repository: {githubRepo}");
                    Console.ResetColor();
                    
                    Console.Write("Update now? (y/n): ");
                    var key = Console.ReadKey();
                    
                    if (key.KeyChar == 'y' || key.KeyChar == 'Y')
                    {
                        await PerformUpdate();
                    }
                }
                else
                {
                    Console.ForegroundColor = ConsoleColor.Green;
                    Console.WriteLine("‚úÖ You have the latest StateW1n version!");
                    Console.ResetColor();
                }
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.DarkYellow;
                Console.WriteLine($"‚ö†Ô∏è  Update check failed: {ex.Message}");
                Console.ResetColor();
            }
        }

        static async Task PerformUpdate()
        {
            try
            {
                Console.WriteLine("\nüì• Downloading StateW1n update...");
                Console.WriteLine($"üîó Source: {exeUrl}");
                
                // –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
                await webClient.DownloadFileTaskAsync(exeUrl, tempUpdateExe);
                
                if (!File.Exists(tempUpdateExe))
                    throw new Exception("Downloaded file not found");

                Console.WriteLine("üìù Creating update script...");
                
                // –°–æ–∑–¥–∞–µ–º BAT —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                string batScript = $@"
@echo off
chcp 65001 >nul
title StateW1n Updater
echo StateW1n Injector Update
echo ========================
echo Waiting for current process to close...
timeout /t 3 /nobreak >nul

:: –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
taskkill /f /im ""{Path.GetFileName(currentExePath)}"" >nul 2>&1
timeout /t 2 /nobreak >nul

:: –ó–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª
echo Updating executable...
move /y ""{tempUpdateExe}"" ""{currentExePath}"" >nul 2>&1

if exist ""{currentExePath}"" (
    echo Update successful!
    echo Starting StateW1n Injector...
    start """" ""{currentExePath}"" --updated
) else (
    echo Update failed!
    pause
)

:: –£–¥–∞–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç
del ""%~f0"" >nul 2>&1
";
                
                File.WriteAllText(tempUpdaterScript, batScript);
                
                Console.WriteLine("üöÄ Restarting StateW1n Injector...");
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                Process.Start(new ProcessStartInfo
                {
                    FileName = tempUpdaterScript,
                    WindowStyle = ProcessWindowStyle.Normal
                });
                
                Environment.Exit(0);
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"‚ùå Update failed: {ex.Message}");
                Console.ResetColor();
                Console.WriteLine("Please download manually from:");
                Console.WriteLine(githubRepo);
            }
        }

        static void CleanupOldVersion()
        {
            try
            {
                string oldExe = Path.Combine(currentDir, "StateW1n_old.exe");
                if (File.Exists(oldExe))
                {
                    File.Delete(oldExe);
                    Console.WriteLine("‚úÖ Cleaned up old version");
                }
                
                if (File.Exists(tempUpdaterScript))
                {
                    File.Delete(tempUpdaterScript);
                }
            }
            catch { }
        }

        static bool IsNewerVersion(string latest, string current)
        {
            try
            {
                Version latestVer = new Version(latest);
                Version currentVer = new Version(current);
                return latestVer > currentVer;
            }
            catch
            {
                return false;
            }
        }

        static void InteractiveMode()
        {
            while (true)
            {
                Console.WriteLine("\n" + new string('‚ïê', 40));
                Console.ForegroundColor = ConsoleColor.Magenta;
                Console.WriteLine("           STATEW1N MENU");
                Console.ResetColor();
                Console.WriteLine(new string('‚ïê', 40));
                Console.WriteLine("1. üìã List Roblox processes");
                Console.WriteLine("2. üéØ Inject Lua script");
                Console.WriteLine("3. üåê Load script from GitHub");
                Console.WriteLine("4. ‚ö° Quick inject (speed)");
                Console.WriteLine("5. üîß Advanced options");
                Console.WriteLine("6. üîÑ Check for updates");
                Console.WriteLine("7. ‚ùå Exit");
                Console.Write("\nSelect option: ");

                string choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        ListRobloxProcesses();
                        break;
                    case "2":
                        InjectManualScript();
                        break;
                    case "3":
                        LoadScriptFromGitHub().Wait();
                        break;
                    case "4":
                        QuickInject();
                        break;
                    case "5":
                        ShowAdvancedOptions();
                        break;
                    case "6":
                        CheckForUpdatesAsync().Wait();
                        break;
                    case "7":
                        return;
                    default:
                        Console.ForegroundColor = ConsoleColor.Red;
                        Console.WriteLine("Invalid option!");
                        Console.ResetColor();
                        break;
                }
            }
        }

        static void ListRobloxProcesses()
        {
            Console.WriteLine("\nüîç Searching for Roblox processes...");
            bool found = false;

            foreach (Process process in Process.GetProcesses())
            {
                try
                {
                    string name = process.ProcessName.ToLower();
                    if (name.Contains("roblox") || name.Contains("windows10universal"))
                    {
                        Console.ForegroundColor = ConsoleColor.Green;
                        Console.WriteLine($"üéØ PID: {process.Id} | Name: {process.ProcessName} | Title: {process.MainWindowTitle}");
                        found = true;
                    }
                }
                catch { }
            }

            if (!found)
            {
                Console.ForegroundColor = ConsoleColor.Yellow;
                Console.WriteLine("‚ùå No Roblox processes found!");
            }
            Console.ResetColor();
        }

        static void InjectManualScript()
        {
            try
            {
                Console.Write("Enter target PID: ");
                int pid = int.Parse(Console.ReadLine());

                Console.WriteLine("Enter Lua script (end with empty line):");
                StringBuilder script = new StringBuilder();
                string line;

                while (!string.IsNullOrEmpty(line = Console.ReadLine()))
                {
                    script.AppendLine(line);
                }

                Console.WriteLine("üöÄ Injecting script...");
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –∏–Ω–∂–µ–∫—Ç–∞
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("‚úÖ Script injected successfully!");
                Console.ResetColor();
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"‚ùå Injection failed: {ex.Message}");
                Console.ResetColor();
            }
        }

        static async Task LoadScriptFromGitHub()
        {
            try
            {
                Console.WriteLine("üåê Available scripts from GitHub:");
                Console.WriteLine("1. Speed hack");
                Console.WriteLine("2. Fly script");
                Console.WriteLine("3. ESP script");
                Console.WriteLine("4. Custom URL");
                Console.Write("Select: ");

                string choice = Console.ReadLine();
                string scriptUrl = "";

                switch (choice)
                {
                    case "1":
                        scriptUrl = luaScriptsUrl + "speed.lua";
                        break;
                    case "2":
                        scriptUrl = luaScriptsUrl + "fly.lua";
                        break;
                    case "3":
                        scriptUrl = luaScriptsUrl + "esp.lua";
                        break;
                    case "4":
                        Console.Write("Enter GitHub RAW URL: ");
                        scriptUrl = Console.ReadLine();
                        break;
                    default:
                        Console.WriteLine("Invalid choice!");
                        return;
                }

                Console.WriteLine($"üì• Downloading from: {scriptUrl}");
                string luaCode = await webClient.DownloadStringTaskAsync(scriptUrl);
                
                Console.Write("Enter target PID: ");
                int pid = int.Parse(Console.ReadLine());

                Console.WriteLine("üöÄ Injecting downloaded script...");
                // –ö–æ–¥ –∏–Ω–∂–µ–∫—Ç–∞
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("‚úÖ GitHub script injected successfully!");
                Console.ResetColor();
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"‚ùå Failed: {ex.Message}");
                Console.ResetColor();
            }
        }

        static void QuickInject()
        {
            try
            {
                Console.WriteLine("‚ö° Quick Inject - Speed Hack");
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏ –∏–Ω–∂–µ–∫—Ç
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine("‚úÖ Speed hack injected to all Roblox processes!");
                Console.ResetColor();
            }
            catch (Exception ex)
            {
                Console.ForegroundColor = ConsoleColor.Red;
                Console.WriteLine($"‚ùå Quick inject failed: {ex.Message}");
                Console.ResetColor();
            }
        }

        static void ShowAdvancedOptions()
        {
            Console.WriteLine("\nüîß Advanced Options:");
            Console.WriteLine("1. Stealth mode");
            Console.WriteLine("2. Bypass anti-cheat");
            Console.WriteLine("3. Custom injection method");
            Console.WriteLine("4. Back to main menu");
            Console.Write("Select: ");

            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –æ–ø—Ü–∏–π
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Advanced features coming soon...");
            Console.ResetColor();
        }

        static void SilentMode(string[] args)
        {
            // –†–µ–∂–∏–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            Console.WriteLine("Silent mode activated");
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω–∂–µ–∫—Ç –ø–æ PID –∏ —Å–∫—Ä–∏–ø—Ç—É
        }
    }
}
